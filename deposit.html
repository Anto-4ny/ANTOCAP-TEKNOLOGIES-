<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanfiat Technologies - My Dashboard</title>
    <meta name="description" content="Sanfiat Technologies offers top-notch products and services advertising.">
    <meta property="og:title" content="Sanfiat Technologies">
    <meta property="og:description" content="Leading provider of products and services advertisment.">
    <meta property="og:image" content=images/Photo_1723191951676.png">
    <meta property="og:url" content="https://www.sanfiat-technologies.com">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="icon" href="images/Photo_1723191951676.png" type="image/x-icon">
    <style>
        /* Basic styling, adjust as needed */
        .hidden { display: none; }
        .show { display: block; }
        .password-toggle { cursor: pointer; }
        #payment-section { margin-top: 20px; }
        .message { color: red; }
    </style>
</head>
    <header>
    <a href="index.html">
        <img id="logo" src="images/Photo_1723191951676.png" alt="Logo">
    </a>
    <button id="hamburger-icon" class="hamburger-menu">
        <img src="images/images.png" alt="Menu Icon">
    </button>
    <nav class="desktop-nav">
        <a href="#home">Home</a>
        <a href="#login-section">Log in</a>
        <a href="#dashboard">Dashboard</a>
        <a href="packages.html">Packages</a>
        <a href="deposit.html">Deposit</a>
       <a href="upload.html">Upload screenshot</a>
    </nav>
    <nav id="mobile-nav" class="mobile-nav">
        <a href="#home">
            <img src="images/home-icon.png" alt="Home"> Home
        </a>
        <a href="#login">
            <img src="images/login-icon.png" alt="Log in"> Log in
        </a>
        <a href="#dashboard">
            <img src="images/dashboard-icon.png" alt="Dashboard"> Dashboard
        </a>
        <a href="packages.html">
            <img src="images/packages-icon.png" alt="Packages"> Packages
        </a>
        <a href="deposit.html">
            <img src="images/deposit-icon.png" alt="Deposit">Deposit</a>
      <a href="upload.html">
            <img src="images/upload-icon.png" alt="upload">Upload screenshot
      </a>
    </nav>
    </header>
    

    <main>

<!-- Payment Section -->
    <div id="payment-section" class="payment-box">
        <h3>Make a Payment</h3>
        <img src="images/Icons/images.jpeg" alt="MPESA Logo" class="mpesa-image">
        <p>To complete your payment via MPESA, follow the steps below:</p>
        <ol>
            <li>Enter your phone number in the field provided below.</li>
            <li>Click the "Pay 250 Ksh" button.</li>
            <li>A pop-up message will appear on your phone from MPESA, prompting you to enter your MPESA PIN.</li>
            <li>After entering your MPESA PIN, you will receive a confirmation message with your transaction code.</li>
            <li>Copy the MPESA transaction code and paste it in the field labeled "Enter MPESA Code" below.</li>
            <li>Submit your transaction code and wait for up to 30 minutes for confirmation.</li>
        </ol>

        <label for="phone-number">Enter Your Phone Number:</label>
        <input type="text" id="phone-number" placeholder="07XX XXX XXX">
        
        <button type="button" id="pay-button">Pay 250 Ksh</button>
        
        <label for="payment-confirmation">Enter MPESA Code:</label>
        <input type="text" id="payment-confirmation" placeholder="MPESA Transaction Code">
        
        <button type="button" id="submit-payment">Submit Payment Code</button>

        <p id="payment-status"></p>
    </div>

    <!-- Confirmation Section -->
    <div id="confirmation-section" class="confirmation-box">
        <h3>Business Payment Details</h3>
        <p><strong>Business Number:</strong> 400200</p>
        <p><strong>Account Number:</strong> 860211</p>

        <label for="confirm-mpesa-code">Enter MPESA Code:</label>
        <input type="text" id="confirm-mpesa-code" placeholder="MPESA Transaction Code">

        <button type="button" id="submit-confirmation">Submit Payment Code</button>
    </div>
                
</div>
   </main>
        <p class="copyright-text">&copy; 2024 Sanfiat Technologies. All rights reserved.</p>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js"></script>

    <!-- Your custom script using Firebase -->
    <script type="module" src="script.js"></script>
    <script>
    // Handle Pay button click
    document.getElementById("pay-button").addEventListener("click", async function() {
        const phoneNumber = document.getElementById("phone-number").value;
        
        if (phoneNumber.length === 10) {
            try {
                // Make a POST request to initiate MPESA payment via the backend
                const response = await fetch('/api/pay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phoneNumber: phoneNumber })
                });

                const result = await response.json();

                if (response.ok) {
                    // Notify user about the STK push and inform about entering the MPESA PIN
                    alert(result.message);
                    console.log('STK Response:', result.stkResponse);
                    // Store payment ID for future use (e.g., updating with payment code)
                    sessionStorage.setItem('paymentId', result.paymentId);
                } else {
                    alert('Payment initiation failed. ' + result.error);
                }
            } catch (error) {
                console.error('Error initiating payment:', error);
                alert('Error initiating payment. Please try again.');
            }
        } else {
            alert('Please enter a valid 10-digit phone number.');
        }
    });

    // Handle payment code submission
    document.getElementById("submit-payment").addEventListener("click", async function() {
        const paymentCode = document.getElementById("payment-confirmation").value;
        const paymentId = sessionStorage.getItem('paymentId');
        
        if (paymentCode && paymentId) {
            try {
                // Make a POST request to update Firestore with the MPESA transaction code
                const response = await fetch(`/api/payments/${paymentId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mpesaCode: paymentCode })
                });

                const result = await response.json();
                if (response.ok) {
                    document.getElementById("payment-status").textContent = "Payment submitted. Please wait for confirmation.";
                } else {
                    alert('Failed to update payment. ' + result.error);
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('Error updating payment. Please try again.');
            }
        } else {
            alert('Please enter the MPESA transaction code.');
        }
    });
                                         </script>
    
</body>
                            </html>
